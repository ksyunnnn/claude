name: ADR Draft Generator
description: Generate ADR drafts automatically based on technical decisions

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to generate ADR draft'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  generate-adr-draft:
    runs-on: ubuntu-latest
    if: contains(github.event.label.name, 'needs-adr') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = github.event_name === 'workflow_dispatch' 
              ? ${{ github.event.inputs.issue_number }}
              : context.issue.number;

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            return {
              title: issue.title,
              body: issue.body,
              number: issue.number,
              labels: issue.labels.map(label => label.name)
            };

      - name: Parse issue content
        id: parse
        run: |
          # Issue ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
          ISSUE_DATA='${{ steps.issue.outputs.result }}'
          
          # æ¬¡ã®ADRç•ªå·ã‚’æ±ºå®š
          ADR_DIR="docs/adr"
          NEXT_NUM=$(ls ${ADR_DIR}/*.md | grep -oE '[0-9]{4}' | sort -n | tail -1)
          NEXT_NUM=$((NEXT_NUM + 1))
          NEXT_ADR_NUM=$(printf "%04d" $NEXT_NUM)
          
          echo "next-adr-number=$NEXT_ADR_NUM" >> $GITHUB_OUTPUT
          echo "issue-data=$ISSUE_DATA" >> $GITHUB_OUTPUT

      - name: Generate ADR draft
        id: generate
        uses: actions/github-script@v7
        with:
          script: |
            const issueData = JSON.parse('${{ steps.parse.outputs.issue-data }}');
            const nextNumber = '${{ steps.parse.outputs.next-adr-number }}';
            
            // Issueå†…å®¹ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
            const title = issueData.title.replace(/^\[ADR\]\s*/, '');
            const body = issueData.body;
            
            // æ±ºå®šç¨®é¡ã‚’æ¨å®š
            let decisionType = "æŠ€è¡“çš„æ±ºå®š";
            if (body.includes("æ–°ã—ã„æŠ€è¡“ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¡ç”¨")) decisionType = "æ–°ã—ã„æŠ€è¡“ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¡ç”¨";
            if (body.includes("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®å¤‰æ›´")) decisionType = "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®å¤‰æ›´";
            if (body.includes("ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´")) decisionType = "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´";
            if (body.includes("UI/UXæˆ¦ç•¥ã®å¤‰æ›´")) decisionType = "UI/UXæˆ¦ç•¥ã®å¤‰æ›´";
            
            // PRç•ªå·ã‚’æŠ½å‡º
            const prMatch = body.match(/PR.*#(\d+)/);
            const prNumber = prMatch ? prMatch[1] : '';
            
            // ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å¤‰æ›´ã‚’æŠ½å‡º
            const packageMatch = body.match(/## ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å¤‰æ›´\s*```diff\s*(.*?)\s*```/s);
            const packageChanges = packageMatch ? packageMatch[1] : '';
            
            // å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
            const filesMatch = body.match(/## ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«\s*```\s*(.*?)\s*```/s);
            const changedFiles = filesMatch ? filesMatch[1] : '';
            
            // ADRãƒ‰ãƒ©ãƒ•ãƒˆã‚’ç”Ÿæˆ
            const adrContent = `# ADR-${nextNumber}: ${title}

## Status

Proposed

## Context

ã“ã®ADRã¯ Issue #${issueData.number} ã«åŸºã¥ã„ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

### èƒŒæ™¯
${prNumber ? `PR #${prNumber}` : 'ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ'}ã«ãŠã‘ã‚‹æŠ€è¡“çš„å¤‰æ›´ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®æ±ºå®šãŒå¿…è¦ã«ãªã‚Šã¾ã—ãŸï¼š

**æ±ºå®šç¨®é¡**: ${decisionType}

### å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
\`\`\`
${changedFiles}
\`\`\`

${packageChanges ? `### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å¤‰æ›´
\`\`\`diff
${packageChanges}
\`\`\`` : ''}

### èª²é¡Œãƒ»åˆ¶ç´„
<!-- ã“ã“ã«å…·ä½“çš„ãªèª²é¡Œã‚„åˆ¶ç´„ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ -->
- ç¾åœ¨ã®æŠ€è¡“çš„èª²é¡Œã¯ä½•ã‹ï¼Ÿ
- ã©ã®ã‚ˆã†ãªåˆ¶ç´„ãŒã‚ã‚‹ã‹ï¼Ÿ
- ãƒ“ã‚¸ãƒã‚¹è¦ä»¶ã¨ã®é–¢é€£ã¯ï¼Ÿ

## Decision

<!-- ã“ã“ã«å…·ä½“çš„ãªæ±ºå®šå†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ -->

**æ¡ç”¨ã™ã‚‹è§£æ±ºç­–**: 

**æ±ºå®šç†ç”±**:
1. 
2. 
3. 

### æ¤œè¨ã—ãŸé¸æŠè‚¢
<!-- ä»–ã«æ¤œè¨ã—ãŸé¸æŠè‚¢ã¨ãã®è©•ä¾¡ -->
- **é¸æŠè‚¢A**: 
  - ãƒ¡ãƒªãƒƒãƒˆ: 
  - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: 
- **é¸æŠè‚¢B**: 
  - ãƒ¡ãƒªãƒƒãƒˆ: 
  - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: 

## Consequences

### Positiveï¼ˆãƒ¡ãƒªãƒƒãƒˆï¼‰

- 

### Negativeï¼ˆãƒ‡ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒªã‚¹ã‚¯ï¼‰

- 

### Neutralï¼ˆä¸­ç«‹çš„ãªå½±éŸ¿ï¼‰

- 

## Implementation Notes

<!-- å®Ÿè£…æ™‚ã®å…·ä½“çš„ãªæ³¨æ„ç‚¹ã‚„è©³ç´° -->

### å®Ÿè£…æ‰‹é †
1. 
2. 
3. 

### æŠ€è¡“çš„è©³ç´°
- 
- 

### ç›£è¦–ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- 
- 

## Related Decisions

${prNumber ? `- PR #${prNumber}: ${title}` : ''}
- Issue #${issueData.number}: é–¢é€£ã™ã‚‹æŠ€è¡“çš„æ±ºå®š

## Future Considerations

<!-- å°†æ¥çš„ãªæ¤œè¨äº‹é … -->
- 
- 

---

**Date**: ${new Date().toISOString().split('T')[0]}  
**Author**: Auto-generated  
**Context**: Issue #${issueData.number} ã«åŸºã¥ãè‡ªå‹•ç”Ÿæˆ  
${prNumber ? `**Reference**: PR #${prNumber}` : ''}

<!-- 
ã“ã®ADRãƒ‰ãƒ©ãƒ•ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
ä»¥ä¸‹ã®é …ç›®ã‚’å¿…ãšç¢ºèªãƒ»æ›´æ–°ã—ã¦ãã ã•ã„ï¼š

â–¡ Context ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°åŒ–
â–¡ Decision ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å…·ä½“åŒ–  
â–¡ Consequences ã®æ­£ç¢ºæ€§ç¢ºèª
â–¡ Implementation Notes ã®è¿½åŠ 
â–¡ Status ã‚’ Proposed â†’ Accepted ã«æ›´æ–°
-->
`;

            return {
              filename: `${nextNumber}-${title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}.md`,
              content: adrContent,
              number: nextNumber
            };

      - name: Create ADR draft file
        id: create-file
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const draftData = JSON.parse('${{ steps.generate.outputs.result }}');
            
            // ADRãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            const filePath = `docs/adr/${draftData.filename}`;
            fs.writeFileSync(filePath, draftData.content);
            
            console.log(`Created ADR draft: ${filePath}`);
            return { filePath, filename: draftData.filename, number: draftData.number };

      - name: Create PR for ADR draft
        uses: actions/github-script@v7
        with:
          script: |
            const fileData = JSON.parse('${{ steps.create-file.outputs.result }}');
            const issueData = JSON.parse('${{ steps.parse.outputs.issue-data }}');
            
            // æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆ
            const branchName = `adr-${fileData.number}-auto-draft`;
            
            // ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆSHAã‚’å–å¾—
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });
            
            // æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: ref.object.sha
              });
            } catch (error) {
              if (error.status !== 422) throw error; // ãƒ–ãƒ©ãƒ³ãƒãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç„¡è¦–
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
            const { data: fileInfo } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: fileData.filePath,
              ref: branchName
            }).catch(() => ({ data: null })); // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ
            
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: fileData.filePath,
              message: `ğŸ¤– è‡ªå‹•ç”Ÿæˆ: ADR-${fileData.number} ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ

Issue #${issueData.number} ã«åŸºã¥ã„ã¦ADRãƒ‰ãƒ©ãƒ•ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚

- æŠ€è¡“çš„æ±ºå®šã®è©³ç´°åŒ–ãŒå¿…è¦
- Context ã¨ Decision ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç¢ºèªãƒ»æ›´æ–°
- å®Ÿè£…è©³ç´°ã®è¿½åŠ 

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)`,
              content: Buffer.from(fs.readFileSync(fileData.filePath)).toString('base64'),
              branch: branchName,
              sha: fileInfo?.sha
            });
            
            // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– ADR-${fileData.number}: ${issueData.title.replace(/^\[ADR\]\s*/, '')}`,
              body: `## ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸADRãƒ‰ãƒ©ãƒ•ãƒˆ

Issue #${issueData.number} ã«åŸºã¥ã„ã¦ã€ADRãƒ‰ãƒ©ãƒ•ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚

### ğŸ“‹ ä½œæˆå†…å®¹
- **ãƒ•ã‚¡ã‚¤ãƒ«**: \`${fileData.filePath}\`
- **ADRç•ªå·**: ${fileData.number}
- **å…ƒIssue**: #${issueData.number}

### âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ç·¨é›†ãŒå¿…è¦ãªé …ç›®
- [ ] Context ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°åŒ–
- [ ] Decision ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å…·ä½“çš„ãªæ±ºå®šå†…å®¹
- [ ] Consequences ã®æ­£ç¢ºæ€§ç¢ºèª  
- [ ] Implementation Notes ã®è¿½åŠ 
- [ ] Status ã‚’ Proposed â†’ Accepted ã«å¤‰æ›´

### ğŸ”— é–¢é€£
- **å…ƒIssue**: #${issueData.number}
- **ADRãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: [docs/adr/](docs/adr/)
- **ADRã‚¬ã‚¤ãƒ‰**: [docs/adr/README.md](docs/adr/README.md)

---
*ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªãƒ»ç·¨é›†ã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚*`,
              head: branchName,
              base: 'main'
            });
            
            // å…ƒã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueData.number,
              body: `## ğŸ¤– ADRãƒ‰ãƒ©ãƒ•ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ

ADR-${fileData.number} ã®ãƒ‰ãƒ©ãƒ•ãƒˆã‚’ä½œæˆã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

### ğŸ“„ ç”Ÿæˆå†…å®¹
- **ãƒ•ã‚¡ã‚¤ãƒ«**: \`${fileData.filePath}\`  
- **PR**: #${pr.number}
- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${branchName}\`

### ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. [PR #${pr.number}](${pr.html_url}) ã§ãƒ‰ãƒ©ãƒ•ãƒˆå†…å®¹ã‚’ç¢ºèª
2. å¿…è¦ã«å¿œã˜ã¦å†…å®¹ã‚’ç·¨é›†ãƒ»è©³ç´°åŒ–
3. ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èªå¾Œã«ãƒãƒ¼ã‚¸

---
*è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ‰ãƒ©ãƒ•ãƒˆã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã—ã¦ãã ã•ã„ã€‚*`
            });

      - name: Update issue labels
        uses: actions/github-script@v7
        with:
          script: |
            const issueData = JSON.parse('${{ steps.parse.outputs.issue-data }}');
            
            // ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ï¼ˆneeds-adr ã‚’å‰Šé™¤ã€draft-created ã‚’è¿½åŠ ï¼‰
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueData.number,
              name: 'needs-adr'
            }).catch(() => {}); // ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueData.number,
              labels: ['adr-draft-created', 'in-review']
            });