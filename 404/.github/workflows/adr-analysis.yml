name: ADR Analysis
description: Analyze PRs for technical decisions and automatically create ADR issues/drafts

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'package.json'              # ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´
      - 'package-lock.json'         # ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´
      - 'src/lib/**'                # ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´
      - 'src/components/ui/**'      # UIæˆ¦ç•¥å¤‰æ›´
      - 'supabase/**'               # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´
      - 'src/app/**'                # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ å¤‰æ›´
      - 'src/middleware.ts'         # ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å¤‰æ›´
      - 'next.config.ts'            # Next.jsè¨­å®šå¤‰æ›´
      - 'tailwind.config.ts'        # ã‚¹ã‚¿ã‚¤ãƒ«æˆ¦ç•¥å¤‰æ›´
      - 'tsconfig.json'             # TypeScriptè¨­å®šå¤‰æ›´

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  analyze-technical-decisions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: pr-diff
        run: |
          # PRå·®åˆ†ã‚’å–å¾—
          git diff origin/${{ github.base_ref }}...${{ github.sha }} > pr_diff.txt
          
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
          git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} > changed_files.txt
          
          echo "changed-files<<EOF" >> $GITHUB_OUTPUT
          cat changed_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze changes
        id: analyze
        run: |
          # æŠ€è¡“çš„æ±ºå®šãŒå¿…è¦ã‹ã©ã†ã‹ã‚’åˆ†æ
          needs_adr=""
          decision_type=""
          priority=""
          
          if grep -q "package.json\|package-lock.json" changed_files.txt; then
            needs_adr="true"
            decision_type="æ–°ã—ã„æŠ€è¡“ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¡ç”¨"
            priority="Medium"
            echo "detected=dependency-change" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "supabase/" changed_files.txt; then
            needs_adr="true"
            decision_type="ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®å¤‰æ›´"
            priority="High"
            echo "detected=database-change" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "src/lib/" changed_files.txt; then
            needs_adr="true"
            decision_type="ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´"
            priority="High"
            echo "detected=architecture-change" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "src/components/ui/" changed_files.txt; then
            needs_adr="true"
            decision_type="UI/UXæˆ¦ç•¥ã®å¤‰æ›´"
            priority="Medium"
            echo "detected=ui-strategy-change" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "middleware.ts\|next.config.ts" changed_files.txt; then
            needs_adr="true"
            decision_type="ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´"
            priority="High"
            echo "detected=config-change" >> $GITHUB_OUTPUT
          fi
          
          echo "needs-adr=$needs_adr" >> $GITHUB_OUTPUT
          echo "decision-type=$decision_type" >> $GITHUB_OUTPUT
          echo "priority=$priority" >> $GITHUB_OUTPUT

      - name: Extract key changes
        id: extract-changes
        if: steps.analyze.outputs.needs-adr == 'true'
        run: |
          # package.json ã®å¤‰æ›´ã‚’æŠ½å‡º
          if grep -q "package.json" changed_files.txt; then
            echo "package-changes<<EOF" >> $GITHUB_OUTPUT
            git diff origin/${{ github.base_ref }}...${{ github.sha }} package.json | grep -E "^\+.*\".*\":" | head -10 >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ã®æ¤œå‡º
          echo "new-files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-status origin/${{ github.base_ref }}...${{ github.sha }} | grep "^A" | head -10 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create ADR issue
        if: steps.analyze.outputs.needs-adr == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const detectedType = '${{ steps.analyze.outputs.detected }}';
            const decisionType = '${{ steps.analyze.outputs.decision-type }}';
            const priority = '${{ steps.analyze.outputs.priority }}';
            const changedFiles = `${{ steps.pr-diff.outputs.changed-files }}`;
            const packageChanges = `${{ steps.extract-changes.outputs.package-changes }}` || 'å¤‰æ›´ãªã—';
            const newFiles = `${{ steps.extract-changes.outputs.new-files }}` || 'æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ãªã—';

            // ADR Issue ã®ä½œæˆ
            const issueBody = `
            ## ğŸ¤– è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸæŠ€è¡“çš„æ±ºå®š

            **PR**: #${context.issue.number} - ${pr.title}
            **æ¤œå‡ºã‚¿ã‚¤ãƒ—**: ${detectedType}
            **æ±ºå®šç¨®é¡**: ${decisionType}
            **å„ªå…ˆåº¦**: ${priority}

            ## ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            \`\`\`
            ${changedFiles}
            \`\`\`

            ## ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å¤‰æ›´
            \`\`\`diff
            ${packageChanges}
            \`\`\`

            ## ğŸ†• æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«
            \`\`\`
            ${newFiles}
            \`\`\`

            ## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. ã“ã®æŠ€è¡“çš„æ±ºå®šãŒADRä½œæˆã«å€¤ã™ã‚‹ã‹ãƒ¬ãƒ“ãƒ¥ãƒ¼
            2. å¿…è¦ã«å¿œã˜ã¦ADRãƒ‰ãƒ©ãƒ•ãƒˆã‚’ä½œæˆ
            3. é–¢é€£ã™ã‚‹æ—¢å­˜ADRã®æ›´æ–°ã‚‚æ¤œè¨

            ## ğŸ”— é–¢é€£æƒ…å ±
            - **PR**: #${context.issue.number}
            - **ä½œæˆè€…**: @${pr.user.login}
            - **ãƒ–ãƒ©ãƒ³ãƒ**: ${pr.head.ref}

            ---
            *ã“ã® Issue ã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚ä¸è¦ãªå ´åˆã¯é–‰ã˜ã¦ãã ã•ã„ã€‚*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ADR] ${decisionType}: ${pr.title}`,
              body: issueBody,
              labels: ['needs-adr', 'technical-decision', 'auto-created', `priority-${priority.toLowerCase()}`]
            });

      - name: Comment on PR
        if: steps.analyze.outputs.needs-adr == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const decisionType = '${{ steps.analyze.outputs.decision-type }}';
            const priority = '${{ steps.analyze.outputs.priority }}';
            
            const comment = `
            ## ğŸ¤– æŠ€è¡“çš„æ±ºå®šã‚’æ¤œå‡ºã—ã¾ã—ãŸ

            ã“ã® PR ã«ã¯ **${decisionType}** (å„ªå…ˆåº¦: **${priority}**) ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

            ### ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            - [ ] æŠ€è¡“çš„æ±ºå®šã®å¦¥å½“æ€§ã‚’ç¢ºèª
            - [ ] å¿…è¦ã«å¿œã˜ã¦ ADR ã®ä½œæˆã‚’æ¤œè¨
            - [ ] æ—¢å­˜ ADR ã¨ã®æ•´åˆæ€§ã‚’ç¢ºèª

            é–¢é€£ã™ã‚‹ Issue ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ãã¡ã‚‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

            ### ğŸ“š å‚è€ƒ
            - [ADR ã¨ã¯](docs/adr/README.md)
            - [æŠ€è¡“æ±ºå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](.github/ISSUE_TEMPLATE/technical-decision.yml)

            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸ*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });